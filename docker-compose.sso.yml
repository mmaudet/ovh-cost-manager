# SSO deployment - OCM with LemonLDAP-NG OIDC Authentication
#
# This deployment uses LemonLDAP-NG as an OIDC Provider with built-in
# reverse proxy (RELAY) to serve OCM. No external proxy (Traefik) needed.
#
# BUILD & RUN:
#   docker compose -f docker-compose.sso.yml build
#   docker compose -f docker-compose.sso.yml up -d
#
# REQUIRED ENVIRONMENT VARIABLES (create .env file or export):
#   SSO_DOMAIN=example.com         # Base domain for SSO (auth.example.com, manager.example.com)
#   OIDC_CLIENT_SECRET=xxx         # OIDC client secret (generate with: openssl rand -hex 32)
#   SESSION_SECRET=xxx             # Session encryption secret (generate with: openssl rand -hex 32)
#
# After first run, configure LemonLDAP via http://manager.${SSO_DOMAIN}:
#   1. Add OIDC Relying Party: ocm-app
#      - Client ID: ocm-dashboard
#      - Client Secret: (same as OIDC_CLIENT_SECRET)
#      - Redirect URIs: http://ocm.${SSO_DOMAIN}/auth/callback
#      - Allowed scopes: openid profile email
#      - Logout URIs: http://ocm.${SSO_DOMAIN} (post_logout_redirect_uri)
#   2. Configure back-channel logout (optional):
#      - Back-channel logout URI: http://ocm:3001/logout/backchannel
#
# ACCESS:
#   Dashboard: http://ocm.${SSO_DOMAIN}/
#   SSO Portal: http://auth.${SSO_DOMAIN}/
#   Manager: http://manager.${SSO_DOMAIN}/

services:
  ocm:
    # Option 1: Build from local Dockerfile (default)
    build:
      context: .
      dockerfile: Dockerfile
    # Option 2: Use pre-built image (comment build section above, uncomment below)
    # image: mmaudet/ovh-cost-manager:latest
    container_name: ovh-cost-manager
    restart: unless-stopped
    volumes:
      - ocm-data:/app/data
      - ./config.json:/app/config.json:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    environment:
      - NODE_ENV=production
      - PORT=3001
      - TRUST_PROXY=true
      # OIDC Configuration
      - OIDC_ENABLED=true
      - OIDC_ISSUER=http://auth.${SSO_DOMAIN:-localhost}
      - OIDC_CLIENT_ID=ocm-dashboard
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-change-me}
      - OIDC_BASE_URL=http://ocm.${SSO_DOMAIN:-localhost}
      - OIDC_SCOPES=openid,profile,email
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
    networks:
      - ocm-network
    depends_on:
      - lemonldap

  # LemonLDAP-NG - SSO Portal & OIDC Provider
  # Using RELAY feature to serve OCM behind the portal
  lemonldap:
    image: yadd/lemonldap-ng-portal:latest
    container_name: lemonldap
    restart: unless-stopped
    environment:
      - SSODOMAIN=${SSO_DOMAIN:-auth.localhost}
      - PORTAL=http://auth.${SSO_DOMAIN:-localhost}
      - LOGLEVEL=notice
      # RELAY: Built-in nginx reverse proxy
      - RELAY=ocm.${SSO_DOMAIN:-localhost}=http://ocm:3001/
      
    volumes:
      - lemonldap-conf:/var/lib/lemonldap-ng/conf
      - lemonldap-sessions:/var/lib/lemonldap-ng/sessions
      - ./demo/sso:/over
    ports:
      - "80:80"
    networks:
      ocm-network:
        aliases:
          - auth.${SSO_DOMAIN:-localhost}
          - manager.${SSO_DOMAIN:-localhost}
          - ocm.${SSO_DOMAIN:-localhost}

volumes:
  ocm-data:
    name: ocm-data
  lemonldap-conf:
    name: lemonldap-conf
  lemonldap-sessions:
    name: lemonldap-sessions

networks:
  ocm-network:
    name: ocm-network
    driver: bridge
